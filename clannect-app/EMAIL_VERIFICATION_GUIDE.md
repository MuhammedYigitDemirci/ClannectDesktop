# Email Verification Flow Guide

## Overview
This guide explains the secure email verification system for email changes in Clannect.

## How It Works

### 1. User Initiates Email Change
- User goes to **Settings → Accounts → Change Email**
- Enters new email address
- Clicks "Send Confirmation"

### 2. Confirmation Email Sent
- Supabase generates a secure verification token
- Confirmation email sent to the **new email address** with a link containing the token
- User is shown a message explaining they need to check their email

### 3. Email Verification Page
- User clicks the link in the confirmation email
- Link directs to `/verify-email?token_hash=XXX&type=email_change`
- The **verify-email** page handles the verification process

### 4. Verification Process
The verification page (`src/app/verify-email/page.tsx`):
1. **Checks user is logged in** - Requires active session for security
2. **Extracts verification token** - Gets `token_hash` and `type` from URL
3. **Verifies token with Supabase** - Uses `verifyOtp()` with type `email_change`
4. **Completes email change** - Automatically applies the email change when token is valid
5. **Shows success confirmation** - Displays the new email address
6. **Redirects to settings** - User automatically redirected after 3 seconds

### 5. Error Handling
The page handles several error scenarios:
- **Expired token**: "This verification link has expired. Please request a new one..."
- **Invalid token**: "This verification link is invalid or has already been used..."
- **Not logged in**: Redirects to login page
- **Missing parameters**: Shows invalid link error

## Security Features

✅ **Token-Based Verification**
- Each confirmation link contains a unique, time-limited token generated by Supabase
- Token can only be used once

✅ **User Authentication Required**
- Page checks that user is logged in before processing
- Prevents unauthorized access

✅ **Email Confirmation**
- Email change happens only after user clicks link in new email
- Proves user has access to the new email address

✅ **Clear User Feedback**
- Success page shows which email was verified
- Error messages guide users on next steps
- Automatic redirects prevent users from getting stuck

## User Flow Diagram

```
Settings Page
    ↓
User enters new email
    ↓
Click "Send Confirmation"
    ↓
Confirmation email sent to NEW email address
    ↓
User receives email with link
    ↓
User clicks verification link
    ↓
/verify-email page loads
    ↓
Token verified with Supabase
    ↓
Email change applied
    ↓
Success page shown with new email
    ↓
Redirect to /settings (3 seconds)
```

## File Structure

```
src/app/
├── settings/
│   └── page.tsx          (Updated: improved email change messaging)
└── verify-email/
    └── page.tsx          (NEW: secure verification endpoint)
```

## Testing the Flow

1. **Go to Settings** → Accounts tab
2. **Click "Change Email"** button
3. **Enter new email** in the modal
4. **Click "Send Confirmation"**
5. **Check the new email address** for Supabase confirmation link
6. **Click the link** in the email
7. **See the "Email Verified" page** with your new email
8. **Automatically redirected** to settings after 3 seconds

## Troubleshooting

### "Verification link is invalid or already used"
- The link may have been used already
- Request a new email change from settings

### "Verification link has expired"
- Supabase links expire after 24 hours
- Request a new email change from settings

### "You must be logged in"
- Your session expired
- Log in again from the login page

### "Invalid verification link"
- The link parameters are missing or malformed
- Request a new email change from settings

## Configuration

### Email Confirmation in Supabase
To enable email confirmation in Supabase Dashboard:
1. Go to **Authentication → Providers → Email**
2. Enable **Confirm email**
3. This makes users verify new emails during signup and email changes

### Rate Limiting
Supabase enforces a 2-hour rate limit on verification emails to prevent abuse. If user requests email confirmation multiple times:
- After 2-3 requests within 2 hours: Email sending is temporarily blocked
- Wait 2 hours before requesting again
- This is a Supabase security feature

## What Happens After Verification

After successful verification:
- ✅ Email is changed in Supabase Auth
- ✅ User is shown the new email on success page
- ✅ User can log in with the new email address
- ✅ Profile continues to show the updated email

---

**Created**: Email verification flow for secure email changes
**Last Updated**: February 1, 2026
